# Nginx配置文件 - RTSP转HLS流媒体服务
# 使用方法:
# 1. 复制到 /etc/nginx/sites-available/rtsp-stream
# 2. 创建软链接: sudo ln -s /etc/nginx/sites-available/rtsp-stream /etc/nginx/sites-enabled/
# 3. 测试配置: sudo nginx -t
# 4. 重启Nginx: sudo systemctl restart nginx

server {
    listen 80;
    # 如果有域名，取消下面的注释并修改
    # server_name your-domain.com;
    
    # 客户端上传大小限制（如果需要）
    client_max_body_size 10M;
    
    # HLS文件访问
    location /hls/ {
        alias /var/www/hls/;
        
        # 禁用缓存，确保获取最新切片
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        
        # CORS支持，允许跨域访问（必须在所有响应中添加）
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS, HEAD' always;
        add_header Access-Control-Allow-Headers 'Range, Content-Type, Accept' always;
        add_header Access-Control-Expose-Headers 'Content-Length, Content-Range' always;
        
        # 处理OPTIONS预检请求
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods 'GET, OPTIONS, HEAD' always;
            add_header Access-Control-Allow-Headers 'Range, Content-Type, Accept' always;
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain charset=UTF-8';
            add_header Content-Length 0;
            return 204;
        }
        
        # MIME类型（重要：确保HLS文件正确识别）
        types {
            application/vnd.apple.mpegurl m3u8;
            video/mp2t ts;
            application/octet-stream ts;  # 备用类型
        }
        
        # 默认类型
        default_type application/vnd.apple.mpegurl;
        
        # 允许范围请求（用于视频流）
        add_header Accept-Ranges bytes;
        
        # 日志记录（调试用，生产环境可关闭）
        access_log /var/log/nginx/hls_access.log;
        error_log /var/log/nginx/hls_error.log;
    }
    
    # 静态页面（播放页面）
    location / {
        root /var/www/html;
        index index.html;
        
        # 明确设置HTML文件的MIME类型（解决手机浏览器下载问题）
        types {
            text/html html htm;
            application/javascript js;
            text/css css;
            application/json json;
            image/png png;
            image/jpeg jpg jpeg;
            image/gif gif;
            image/svg+xml svg;
            image/x-icon ico;
        }
        default_type text/html;
        
        # 允许跨域（如果需要）
        add_header Access-Control-Allow-Origin *;
    }
    
    # 健康检查端点（可选）
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
