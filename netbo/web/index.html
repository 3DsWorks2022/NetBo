<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTSPç›´æ’­æ’­æ”¾å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .player-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 æ¯”ä¾‹ */
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.playing {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .info {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9em;
            color: #495057;
        }

        .info code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .player-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¹ RTSPç›´æ’­æ’­æ”¾å™¨</h1>
            <p>å®æ—¶è§†é¢‘æµæ’­æ”¾</p>
        </div>

        <div class="player-container">
            <div class="video-wrapper">
                <video id="video" controls loop="false"></video>
            </div>

            <div id="status" class="status connecting">
                â³ æ­£åœ¨è¿æ¥...
            </div>

            <div class="controls">
                <button class="btn-primary" onclick="playStream()">â–¶ï¸ æ’­æ”¾</button>
                <button class="btn-secondary" onclick="pauseStream()">â¸ï¸ æš‚åœ</button>
                <button class="btn-danger" onclick="stopStream()">â¹ï¸ åœæ­¢</button>
                <button class="btn-secondary" onclick="reloadStream()">ğŸ”„ é‡æ–°åŠ è½½</button>
            </div>

            <div class="info">
                <strong>æµåœ°å€:</strong> <code id="streamUrlDisplay">è‡ªåŠ¨æ£€æµ‹</code><br>
                <strong>æ’­æ”¾å™¨:</strong> HLS.js (æ”¯æŒä½å»¶è¿Ÿæ¨¡å¼)<br>
                <strong>ç¼“å†²æ—¶é•¿:</strong> <span id="bufferInfo">è®¡ç®—ä¸­...</span>ç§’
            </div>
        </div>
    </div>

    <script>
        let video = document.getElementById('video');
        let hls = null;
        
        // è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒå¹¶è®¾ç½®æ­£ç¡®çš„æµåœ°å€
        // ç»Ÿä¸€ä½¿ç”¨ç»å¯¹è·¯å¾„ /hls/stream.m3u8ï¼Œå› ä¸ºPythonæœåŠ¡å™¨å·²ç»æ”¯æŒè¿™ä¸ªè·¯å¾„
        function getStreamUrl() {
            // ä¼˜å…ˆä½¿ç”¨URLå‚æ•°æŒ‡å®šçš„æµåœ°å€
            const urlParams = new URLSearchParams(window.location.search);
            const customUrl = urlParams.get('stream');
            if (customUrl) {
                return customUrl;
            }
            
            // ç»Ÿä¸€ä½¿ç”¨ç»å¯¹è·¯å¾„ /hls/stream.m3u8
            // Python HTTPæœåŠ¡å™¨å’ŒNginxéƒ½æ”¯æŒè¿™ä¸ªè·¯å¾„
            return './hls/stream.m3u8';
        }
        
        let streamUrl = getStreamUrl();
        let retryCount = 0; // é‡è¯•è®¡æ•°å™¨
        let maxRetries = 3; // æœ€å¤§é‡è¯•æ¬¡æ•°
        let isRetrying = false; // æ˜¯å¦æ­£åœ¨é‡è¯•
        
        // ä»URLå‚æ•°è·å–ç¼“å­˜é…ç½®ï¼Œæˆ–ä½¿ç”¨é»˜è®¤å€¼
        function getConfigValue(paramName, defaultValue) {
            const urlParams = new URLSearchParams(window.location.search);
            const value = urlParams.get(paramName);
            return value ? parseInt(value) : defaultValue;
        }
        
        // è·å–ç¼“å­˜é…ç½®ï¼ˆä¼˜å…ˆä½¿ç”¨URLå‚æ•°ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼‰
        // é»˜è®¤å€¼éœ€è¦ä¸config/stream.confä¸­çš„PLAYER_MAX_BUFFER_LENGTHå’ŒPLAYER_LIVE_SYNC_COUNTä¿æŒä¸€è‡´
        const maxBufferLength = getConfigValue('buffer', 30);
        const liveSyncCount = getConfigValue('sync', 3);

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
        }
        
        // æ›´æ–°ç¼“å†²ä¿¡æ¯æ˜¾ç¤º
        function updateBufferInfo() {
            const bufferInfoEl = document.getElementById('bufferInfo');
            if (bufferInfoEl) {
                bufferInfoEl.textContent = maxBufferLength + 'ç§’ (åŒæ­¥' + liveSyncCount + 'ä¸ªåˆ‡ç‰‡)';
            }
        }

        // åˆå§‹åŒ–HLSæ’­æ”¾å™¨
        function initPlayer() {
            // æ›´æ–°æ˜¾ç¤ºçš„æµåœ°å€
            const streamUrlDisplay = document.getElementById('streamUrlDisplay');
            if (streamUrlDisplay) {
                streamUrlDisplay.textContent = streamUrl;
            }
            
            // æ£€æŸ¥HLS.jsæ˜¯å¦åŠ è½½
            if (typeof Hls === 'undefined') {
                updateStatus('âŒ HLS.jsåº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                console.error('HLS.jsæœªåŠ è½½');
                return;
            }
            
            if (Hls.isSupported()) {
                console.log('åˆå§‹åŒ–HLSæ’­æ”¾å™¨ï¼Œæµåœ°å€:', streamUrl);
                console.log('å½“å‰ç¯å¢ƒ:', {
                    hostname: window.location.hostname,
                    port: window.location.port,
                    pathname: window.location.pathname,
                    protocol: window.location.protocol
                });
                
                hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true, // ä½å»¶è¿Ÿæ¨¡å¼
                    backBufferLength: 90,
                    maxBufferLength: maxBufferLength, // ä½¿ç”¨é…ç½®å€¼
                    maxMaxBufferLength: maxBufferLength * 2,
                    maxBufferSize: maxBufferLength * 2 * 1000 * 1000,
                    maxBufferHole: 0.5,
                    highBufferWatchdogPeriod: 2,
                    nudgeOffset: 0.1,
                    nudgeMaxRetry: 5, // å¢åŠ é‡è¯•æ¬¡æ•°
                    maxFragLoadingTimeOut: 10, // å¢åŠ è¶…æ—¶æ—¶é—´
                    fragLoadingTimeOut: 5, // å¢åŠ ç‰‡æ®µåŠ è½½è¶…æ—¶
                    manifestLoadingTimeOut: 5, // å¢åŠ æ¸…å•åŠ è½½è¶…æ—¶
                    liveSyncDurationCount: liveSyncCount, // ä½¿ç”¨é…ç½®å€¼
                    liveMaxLatencyDurationCount: liveSyncCount + 2, // æœ€å¤§å»¶è¿ŸæŒç»­æ—¶é—´
                    xhrSetup: function(xhr, url) {
                        // æ·»åŠ CORSæ”¯æŒ
                        xhr.withCredentials = false;
                    }
                });

                // å…ˆæµ‹è¯•æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                fetch(streamUrl, { method: 'HEAD' })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                        }
                        console.log('âœ“ HLSæ–‡ä»¶å¯è®¿é—®:', streamUrl);
                        hls.loadSource(streamUrl);
                        hls.attachMedia(video);
                    })
                    .catch(error => {
                        console.error('æ— æ³•è®¿é—®HLSæ–‡ä»¶:', error);
                        updateStatus('âŒ æ— æ³•è®¿é—®æµæ–‡ä»¶: ' + streamUrl + ' (é”™è¯¯: ' + error.message + ')', 'error');
                    });

                // äº‹ä»¶ç›‘å¬
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    updateStatus('âœ… æµå·²åŠ è½½ï¼Œå¯ä»¥æ’­æ”¾', 'playing');
                    // é‡ç½®é‡è¯•è®¡æ•°ï¼ˆæˆåŠŸåŠ è½½åï¼‰
                    retryCount = 0;
                    isRetrying = false;
                    // æ›´æ–°ç¼“å†²ä¿¡æ¯æ˜¾ç¤º
                    updateBufferInfo();
                    video.play().catch(e => {
                        console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢:', e);
                        updateStatus('âš ï¸ ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹æ’­æ”¾', 'connecting');
                    });
                });

                hls.on(Hls.Events.ERROR, function(event, data) {
                    // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                    let errorMsg = 'HLSé”™è¯¯: ';
                    if (data.type) {
                        errorMsg += 'ç±»å‹=' + data.type + ', ';
                    }
                    if (data.details) {
                        errorMsg += 'è¯¦æƒ…=' + data.details + ', ';
                    }
                    if (data.fatal !== undefined) {
                        errorMsg += 'è‡´å‘½=' + data.fatal + ', ';
                    }
                    if (data.url) {
                        errorMsg += 'URL=' + data.url + ', ';
                    }
                    if (data.response) {
                        errorMsg += 'å“åº”=' + JSON.stringify(data.response) + ', ';
                    }
                    if (data.code) {
                        errorMsg += 'ä»£ç =' + data.code + ', ';
                    }
                    console.error(errorMsg, data);
                    
                    // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆç”¨äºè°ƒè¯•ï¼‰
                    if (data.fatal) {
                        let userMsg = 'âŒ HLSé”™è¯¯: ';
                        if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                            userMsg += 'ç½‘ç»œé”™è¯¯';
                            if (data.details === Hls.ErrorDetails.MANIFEST_LOAD_ERROR) {
                                userMsg += ' (æ— æ³•åŠ è½½æ’­æ”¾åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥è·¯å¾„: ' + streamUrl + ')';
                            } else if (data.details === Hls.ErrorDetails.MANIFEST_LOAD_TIMEOUT) {
                                userMsg += ' (åŠ è½½è¶…æ—¶)';
                            } else if (data.details === Hls.ErrorDetails.FRAG_LOAD_ERROR) {
                                userMsg += ' (æ— æ³•åŠ è½½è§†é¢‘ç‰‡æ®µ)';
                            } else if (data.details) {
                                userMsg += ' (' + data.details + ')';
                            }
                        } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                            userMsg += 'åª’ä½“é”™è¯¯';
                            if (data.details) {
                                userMsg += ' (' + data.details + ')';
                            }
                        } else if (data.type === Hls.ErrorTypes.MUX_ERROR) {
                            userMsg += 'æ ¼å¼é”™è¯¯';
                        } else {
                            userMsg += (data.type || 'æœªçŸ¥é”™è¯¯');
                            if (data.details) {
                                userMsg += ' (' + data.details + ')';
                            }
                        }
                        // åœ¨æ§åˆ¶å°æ˜¾ç¤ºå®Œæ•´é”™è¯¯å¯¹è±¡
                        console.error('ç”¨æˆ·å¯è§é”™è¯¯:', userMsg);
                        console.error('å®Œæ•´é”™è¯¯å¯¹è±¡:', JSON.stringify(data, null, 2));
                        // æš‚æ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆåœ¨é‡è¯•å‰ï¼‰
                        if (!isRetrying) {
                            updateStatus(userMsg, 'error');
                        }
                    } else {
                        // éè‡´å‘½é”™è¯¯ï¼Œåªè®°å½•æ—¥å¿—
                        console.warn('HLSéè‡´å‘½é”™è¯¯:', data);
                    }
                    
                    if (data.fatal) {
                        // æ£€æŸ¥é‡è¯•æ¬¡æ•°
                        if (retryCount >= maxRetries) {
                            updateStatus('âŒ é‡è¯•æ¬¡æ•°è¿‡å¤šï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢', 'error');
                            return;
                        }
                        
                        if (isRetrying) {
                            return; // å¦‚æœæ­£åœ¨é‡è¯•ï¼Œä¸å†å¤„ç†
                        }
                        
                        isRetrying = true;
                        retryCount++;
                        
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                updateStatus('âŒ ç½‘ç»œé”™è¯¯ï¼Œå°è¯•é‡æ–°åŠ è½½ (' + retryCount + '/' + maxRetries + ')...', 'error');
                                // å»¶è¿Ÿåé‡è¯•ï¼Œé¿å…é¢‘ç¹é‡è¯•
                                setTimeout(function() {
                                    try {
                                        hls.startLoad();
                                        isRetrying = false;
                                    } catch(e) {
                                        console.error('é‡è¯•å¤±è´¥:', e);
                                        isRetrying = false;
                                        if (retryCount < maxRetries) {
                                            reloadStream();
                                        }
                                    }
                                }, 2000);
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                updateStatus('âŒ åª’ä½“é”™è¯¯ï¼Œå°è¯•æ¢å¤ (' + retryCount + '/' + maxRetries + ')...', 'error');
                                // å°è¯•æ¢å¤åª’ä½“é”™è¯¯
                                try {
                                    hls.recoverMediaError();
                                    isRetrying = false;
                                } catch(e) {
                                    console.error('æ¢å¤å¤±è´¥:', e);
                                    isRetrying = false;
                                    if (retryCount < maxRetries) {
                                        setTimeout(function() {
                                            reloadStream();
                                        }, 2000);
                                    }
                                }
                                break;
                            default:
                                updateStatus('âŒ è‡´å‘½é”™è¯¯ï¼Œ3ç§’åè‡ªåŠ¨é‡æ–°åŠ è½½ (' + retryCount + '/' + maxRetries + ')', 'error');
                                // è‡´å‘½é”™è¯¯ï¼Œå»¶è¿Ÿåé‡æ–°åŠ è½½
                                setTimeout(function() {
                                    isRetrying = false;
                                    if (retryCount < maxRetries) {
                                        reloadStream();
                                    }
                                }, 3000);
                                break;
                        }
                    } else {
                        // éè‡´å‘½é”™è¯¯ï¼Œåªè®°å½•æ—¥å¿—ï¼Œä¸é‡è¯•
                        console.warn('HLSè­¦å‘Š:', data);
                    }
                });

                hls.on(Hls.Events.FRAG_LOADED, function() {
                    updateStatus('âœ… æ­£åœ¨æ’­æ”¾', 'playing');
                });

                // ç›‘å¬ç¼“å†²çŠ¶æ€
                hls.on(Hls.Events.BUFFER_APPENDING, function() {
                    // ç¼“å†²åŒºæ­£åœ¨è¿½åŠ æ•°æ®
                });

                hls.on(Hls.Events.BUFFER_APPENDED, function() {
                    // ç¼“å†²åŒºè¿½åŠ å®Œæˆ
                });

                // ç›‘å¬æ’­æ”¾çŠ¶æ€
                hls.on(Hls.Events.PLAYING, function() {
                    updateStatus('âœ… æ­£åœ¨æ’­æ”¾', 'playing');
                });

                // ç›‘å¬ç­‰å¾…æ•°æ®çŠ¶æ€
                hls.on(Hls.Events.WAITING, function() {
                    updateStatus('â³ ç¼“å†²ä¸­...', 'connecting');
                });

            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // åŸç”ŸHLSæ”¯æŒï¼ˆSafariï¼‰
                video.src = streamUrl;
                video.addEventListener('loadedmetadata', function() {
                    updateStatus('âœ… æµå·²åŠ è½½ï¼ˆåŸç”ŸHLSï¼‰', 'playing');
                });
                video.addEventListener('error', function() {
                    updateStatus('âŒ æ’­æ”¾é”™è¯¯', 'error');
                });
            } else {
                updateStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒHLSæ’­æ”¾', 'error');
            }
        }

        // æ’­æ”¾
        function playStream() {
            if (video.paused) {
                // å¦‚æœHLSæœªåˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–
                if (!hls && Hls.isSupported()) {
                    initPlayer();
                    return;
                }
                video.play().then(() => {
                    updateStatus('âœ… æ­£åœ¨æ’­æ”¾', 'playing');
                    retryCount = 0; // æ’­æ”¾æˆåŠŸï¼Œé‡ç½®é‡è¯•è®¡æ•°
                }).catch(e => {
                    console.error('æ’­æ”¾å¤±è´¥:', e);
                    updateStatus('âŒ æ’­æ”¾å¤±è´¥: ' + e.message, 'error');
                    // æ’­æ”¾å¤±è´¥æ—¶ä¸è‡ªåŠ¨é‡è¯•ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
                });
            }
        }

        // æš‚åœ
        function pauseStream() {
            video.pause();
            updateStatus('â¸ï¸ å·²æš‚åœ', 'connecting');
        }

        // åœæ­¢
        function stopStream() {
            video.pause();
            video.currentTime = 0;
            if (hls) {
                hls.stopLoad();
            }
            updateStatus('â¹ï¸ å·²åœæ­¢', 'connecting');
        }

        // é‡æ–°åŠ è½½
        function reloadStream() {
            if (isRetrying) {
                return; // å¦‚æœæ­£åœ¨é‡è¯•ï¼Œä¸é‡å¤æ‰§è¡Œ
            }
            isRetrying = true;
            updateStatus('ğŸ”„ æ­£åœ¨é‡æ–°åŠ è½½...', 'connecting');
            if (hls) {
                hls.destroy();
                hls = null;
            }
            video.src = '';
            video.pause();
            setTimeout(() => {
                isRetrying = false;
                initPlayer();
            }, 1000);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ—¶æ›´æ–°ç¼“å†²ä¿¡æ¯
            updateBufferInfo();
            initPlayer();
        });

        // å®šæœŸæ£€æŸ¥æ’­æ”¾çŠ¶æ€ï¼Œé˜²æ­¢å¡æ­»ï¼ˆä½†é¿å…å¾ªç¯ï¼‰
        let lastCheckTime = Date.now();
        setInterval(function() {
            // å¦‚æœæ­£åœ¨é‡è¯•ï¼Œä¸æ‰§è¡Œæ£€æŸ¥
            if (isRetrying) {
                return;
            }
            
            if (hls && !video.paused) {
                // å¦‚æœè§†é¢‘åœ¨æ’­æ”¾ä½†ç¼“å†²ä¸ºç©ºï¼Œå°è¯•æ¢å¤
                if (video.readyState < 2 && video.networkState === 3) {
                    // é™åˆ¶æ£€æŸ¥é¢‘ç‡ï¼Œé¿å…é¢‘ç¹è§¦å‘
                    let now = Date.now();
                    if (now - lastCheckTime > 10000) { // è‡³å°‘é—´éš”10ç§’
                        console.warn('æ£€æµ‹åˆ°æ’­æ”¾å¡é¡¿ï¼Œå°è¯•æ¢å¤...');
                        updateStatus('âš ï¸ æ£€æµ‹åˆ°å¡é¡¿ï¼Œæ­£åœ¨æ¢å¤...', 'connecting');
                        try {
                            hls.startLoad();
                            lastCheckTime = now;
                        } catch(e) {
                            console.error('æ¢å¤å¤±è´¥:', e);
                        }
                    }
                }
            }
        }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶å¤„ç†
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶æš‚åœ
                if (!video.paused) {
                    video.pause();
                }
            }
        });
    </script>
</body>
</html>
